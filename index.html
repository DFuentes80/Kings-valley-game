<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-M">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King's Valley</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            flex-direction: column; /* Allow vertical stacking */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem; /* Increased padding */
            text-align: center;
            max-width: 90%; /* Responsive width */
            width: 500px; /* Max width for larger screens */
            margin-bottom: 20px; /* Space below game container */
        }

        .game-title {
            font-size: 2.5rem; /* Larger title */
            font-weight: 700;
            color: #2c3e50; /* Darker title color */
            margin-bottom: 1.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        .board {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5x5 board */
            grid-template-rows: repeat(5, 1fr);
            width: 100%;
            max-width: 400px; /* Fixed size for the board itself */
            height: 400px;
            margin: 0 auto 2rem auto; /* Center board and add margin below */
            border: 6px solid #8e44ad; /* Purple border */
            border-radius: 0.75rem; /* Rounded board corners */
            overflow: hidden; /* Ensures pieces don't overflow rounded corners */
        }

        .square {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #34495e;
            box-sizing: border-box;
            border: 1px solid rgba(0, 0, 0, 0.1); /* Subtle grid lines */
        }

        .square:nth-child(odd) {
            background-color: #ecf0f1; /* Light gray */
        }

        .square:nth-child(even) {
            background-color: #bdc3c7; /* Slightly darker gray */
        }

        /* Center square - King's Valley */
        .square[data-row="2"][data-col="2"] {
            background-color: #f39c12; /* Orange for the King's Valley */
            color: #ffffff;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%; /* Circular pieces */
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .piece:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .player-1-color {
            background-color: #e74c3c; /* Red */
        }

        .player-2-color {
            background-color: #3498db; /* Blue */
        }

        .player-1-color.king {
            background-color: #c0392b; /* Darker Red for King */
            border: 3px solid #f1c40f; /* Gold border for King */
            font-size: 1.5rem;
        }

        .player-2-color.king {
            background-color: #2980b9; /* Darker Blue for King */
            border: 3px solid #f1c40f; /* Gold border for King */
            font-size: 1.5rem;
        }

        .highlight-move {
            background-color: rgba(46, 204, 113, 0.5); /* Green highlight for valid moves */
            cursor: pointer;
            border: 2px dashed #27ae60;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .game-container {
                padding: 1.5rem;
            }
            .game-title {
                font-size: 2rem;
            }
            .board {
                max-width: 300px;
                height: 300px;
            }
            .square {
                font-size: 1.2rem;
            }
            .piece {
                font-size: 1rem;
            }
            .player-1-color.king, .player-2-color.king {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div id="lobbyContainer" class="game-container">
        <h1 class="game-title">King's Valley Lobby</h1>
        <div class="flex flex-col space-y-4">
            <!-- NEW: Nickname Input -->
            <input type="text" id="nicknameInput" placeholder="Enter your nickname" class="p-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-purple-500">

            <button id="createGameButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-300">
                Create New Game
            </button>
            <input type="text" id="gameIdInput" placeholder="Enter Game ID to Join" class="p-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button id="joinGameButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-300">
                Join Game
            </button>
            <!-- NEW: More visible Game ID display -->
            <p id="gameIdDisplay" class="text-2xl font-bold text-green-700 hidden mt-4"></p>

            <p id="sharableLinkDisplay" class="text-gray-700 text-sm mt-2 hidden">
                Share this link: <a id="gameLink" class="text-blue-500 hover:underline" href="#"></a>
                <button id="copyLinkButton" class="ml-2 bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs px-2 py-1 rounded">Copy</button>
            </p>
            <p id="lobbyMessage" class="text-sm text-gray-500"></p>
        </div>
    </div>

    <div id="gameContainer" class="game-container hidden"> <!-- Added 'hidden' class initially -->
        <h1 class="game-title">King's Valley</h1>
        <div id="gameBoard" class="board">
            <!-- Board squares will be generated here by JavaScript -->
        </div>
        <div class="text-lg font-semibold text-gray-700 mt-4">
            <p>Current Player: <span id="currentPlayerDisplay" class="text-red-500">Player 1</span></p>
            <p>Message: <span id="gameMessage" class="text-gray-600">Welcome to King's Valley!</span></p>
            <!-- NEW: Play Again Button -->
            <button id="playAgainButton" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-lg hidden transition duration-300">
                Play Again
            </button>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyA9G_JmOZnNCchThqK0hfiWmFz_Q26hd0E",
          authDomain: "king-s-valley.firebaseapp.com",
          databaseURL: "https://king-s-valley-default-rtdb.firebaseio.com",
          projectId: "king-s-valley",
          storageBucket: "king-s-valley.firebasestorage.app",
          messagingSenderId: "53430172413",
          appId: "1:53430172413:web:1b1c081d5e79aab6931c94",
          measurementId: "G-7QYSRLSVPH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // --- NEW GLOBALS FOR MULTIPLAYER ---
        let currentGameId = null;
        let isPlayer1 = false; // To determine if this client is Player 1 or Player 2
        let playerNickname = "Guest"; // NEW: Default nickname

        // --- NEW UI ELEMENTS ---
        const lobbyContainer = document.getElementById('lobbyContainer');
        const gameContainer = document.getElementById('gameContainer');
        const createGameButton = document.getElementById('createGameButton');
        const gameIdInput = document.getElementById('gameIdInput');
        const joinGameButton = document.getElementById('joinGameButton');
        const lobbyMessage = document.getElementById('lobbyMessage');
        const sharableLinkDisplay = document.getElementById('sharableLinkDisplay');
        const gameLink = document.getElementById('gameLink');
        const copyLinkButton = document.getElementById('copyLinkButton');
        // NEW: Nickname input and Game ID display elements
        const nicknameInput = document.getElementById('nicknameInput');
        const gameIdDisplay = document.getElementById('gameIdDisplay');
        // NEW: Play Again button
        const playAgainButton = document.getElementById('playAgainButton');


        // --- EXISTING GAME GLOBALS ---
        const boardElement = document.getElementById('gameBoard');
        const currentPlayerDisplay = document.getElementById('currentPlayerDisplay');
        const gameMessage = document.getElementById('gameMessage');

        // Initial board state (this will eventually come from the database)
        let board = [
            [2, 2, '2K', 2, 2],
            [0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0], // Center square (2,2) is the King's Valley
            [0, 0, 0, 0, 0],
            [1, 1, '1K', 1, 1]
        ];
        let currentPlayer = 1; // This will also be synchronized from the database
        let selectedPiece = null; // DOM element reference
        let selectedPieceCoords = null; // [row, col]


        // --- NEW/MODIFIED: Sharable Game ID & Nickname updates ---
        // Function to parse query parameters
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check for nickname in local storage or prompt
            const storedNickname = localStorage.getItem('king_s_valley_nickname');
            if (storedNickname) {
                playerNickname = storedNickname;
                nicknameInput.value = storedNickname;
            } else {
                // You could prompt here or let them type it
                nicknameInput.value = `Player${Math.floor(Math.random() * 1000)}`; // Suggest a random name
            }

            const initialGameId = getQueryParam('gameId');
            if (initialGameId) {
                gameIdInput.value = initialGameId;
                lobbyMessage.textContent = `Game ID found in URL. Enter your nickname and click Join Game!`;
            }
        });

        // Save nickname when input changes
        nicknameInput.addEventListener('change', () => {
            playerNickname = nicknameInput.value.trim();
            if (playerNickname === "") {
                playerNickname = "Guest";
                nicknameInput.value = playerNickname;
            }
            localStorage.setItem('king_s_valley_nickname', playerNickname);
        });

        copyLinkButton.addEventListener('click', () => {
            if (gameLink.href) {
                navigator.clipboard.writeText(gameLink.href).then(() => {
                    lobbyMessage.textContent = 'Link copied to clipboard!';
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    lobbyMessage.textContent = 'Failed to copy link. Please copy it manually.';
                });
            }
        });

        // NEW: Play Again button listener
        playAgainButton.addEventListener('click', async () => {
            if (currentGameId && (isPlayer1 || currentPlayer === 1)) { // Only Player 1 or current winner can initiate
                await set(ref(database, 'games/' + currentGameId), {
                    board: [ // Reset board state
                        [2, 2, '2K', 2, 2],
                        [0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0],
                        [1, 1, '1K', 1, 1]
                    ],
                    currentPlayer: 1,
                    player1Name: player1Name, // Keep player names
                    player2Name: player2Name,
                    status: 'playing', // Reset status to playing
                    winner: null
                });
                gameMessage.textContent = "Game reset! Player 1 starts.";
                playAgainButton.classList.add('hidden'); // Hide button after resetting
            } else if (!isPlayer1 && currentPlayer === 2) {
                gameMessage.textContent = "Only Player 1 can initiate a reset, or the winning player.";
            }
        });


        // --- LOBBY LOGIC ---

        createGameButton.addEventListener('click', async () => {
            playerNickname = nicknameInput.value.trim(); // Ensure latest nickname is used
            if (playerNickname === "") {
                playerNickname = `Player${Math.floor(Math.random() * 1000)}`;
                nicknameInput.value = playerNickname;
                localStorage.setItem('king_s_valley_nickname', playerNickname);
            }

            const newGameId = 'game_' + Math.random().toString(36).substring(2, 9); // Simple unique ID
            const gameRef = ref(database, 'games/' + newGameId);

            // Set initial game state in the database
            await set(gameRef, {
                board: [ // Initial board state
                    [2, 2, '2K', 2, 2],
                    [0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0],
                    [1, 1, '1K', 1, 1]
                ],
                currentPlayer: 1,
                player1Name: playerNickname, // NEW: Store Player 1's nickname
                player2Name: null, // NEW: Player 2 not yet joined
                status: 'waiting', // Game is waiting for another player
                winner: null
            });

            currentGameId = newGameId;
            isPlayer1 = true;
            // NEW: Construct and display the sharable link and Game ID
            const shareUrl = window.location.origin + window.location.pathname + '?gameId=' + newGameId;
            gameLink.href = shareUrl;
            gameLink.textContent = shareUrl;
            sharableLinkDisplay.classList.remove('hidden'); // Show the link display
            gameIdDisplay.textContent = `Game ID: ${newGameId}`; // Display the ID prominently
            gameIdDisplay.classList.remove('hidden');
            lobbyMessage.textContent = `Game created! Share the link above with a friend.`;
            console.log("Game created with ID:", newGameId, "Share URL:", shareUrl);
            startGameListener(newGameId); // Start listening for changes to THIS game
            // Removed: showGameScreen(); -> Game screen will appear when status is 'playing'
        });

        joinGameButton.addEventListener('click', async () => {
            playerNickname = nicknameInput.value.trim(); // Ensure latest nickname is used
            if (playerNickname === "") {
                playerNickname = `Player${Math.floor(Math.random() * 1000)}`;
                nicknameInput.value = playerNickname;
                localStorage.setItem('king_s_valley_nickname', playerNickname);
            }

            const gameIdToJoin = gameIdInput.value.trim();
            if (gameIdToJoin) {
                const gameRef = ref(database, 'games/' + gameIdToJoin);
                // Use onValue with { onlyOnce: true } to check initial state
                onValue(gameRef, async (snapshot) => {
                    const gameData = snapshot.val();
                    if (gameData && !gameData.player2Name) { // Check if game exists and has space
                        await set(ref(database, 'games/' + gameIdToJoin + '/player2Name'), playerNickname); // NEW: Mark Player 2 joined with nickname
                        await set(ref(database, 'games/' + gameIdToJoin + '/status'), 'playing'); // Set status to playing
                        currentGameId = gameIdToJoin;
                        isPlayer1 = false; // This client is Player 2
                        lobbyMessage.textContent = `Joined game: ${gameIdToJoin}!`;
                        console.log("Joined game:", gameIdToJoin);
                        startGameListener(gameIdToJoin);
                        // Removed: showGameScreen(); -> Game screen will appear when status is 'playing'
                    } else if (gameData && gameData.player2Name) {
                        lobbyMessage.textContent = `Game ${gameIdToJoin} is already full or doesn't exist.`;
                    } else {
                        lobbyMessage.textContent = `Game ${gameIdToJoin} not found.`;
                    }
                }, { onlyOnce: true }); // We only want to check the initial state once
            } else {
                lobbyMessage.textContent = "Please enter a Game ID.";
            }
        });

        let player1Name = "Player 1"; // Global to hold current player names from DB
        let player2Name = "Player 2"; // Global to hold current player names from DB

        // The showGameScreen function now only handles the UI switch
        function showGameScreen() {
            lobbyContainer.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            // gameMessage.textContent will be set by the listener based on status
            updateGameInfo();
            renderBoard();
        }

        // --- MODIFIED: Function to listen for game changes from the database ---
        function startGameListener(gameId) {
            const gameRef = ref(database, 'games/' + gameId);
            onValue(gameRef, (snapshot) => {
                const gameData = snapshot.val();
                if (gameData) {
                    // Update local state with data from database
                    board = gameData.board;
                    currentPlayer = gameData.currentPlayer;
                    player1Name = gameData.player1Name || "Player 1"; // NEW: Update names
                    player2Name = gameData.player2Name || "Player 2"; // NEW: Update names

                    // Only show game screen if status is 'playing'
                    if (gameData.status === 'playing') {
                        showGameScreen(); // Trigger the UI switch to game
                        gameMessage.textContent = "Game started! Make your move!";
                        playAgainButton.classList.add('hidden'); // Ensure hidden during play
                    } else if (gameData.status === 'waiting') {
                        // Keep in lobby, update message for Player 1
                        lobbyMessage.textContent = `Game created! Share the link with ${player1Name || 'your friend'}. Waiting for Player 2...`;
                        sharableLinkDisplay.classList.remove('hidden');
                        gameIdDisplay.classList.remove('hidden');
                        gameIdDisplay.textContent = `Game ID: ${gameId}`;
                    } else if (gameData.status === 'finished') {
                         gameMessage.textContent = `Game Over! ${gameData.winner === 1 ? player1Name : player2Name} won!`;
                         playAgainButton.classList.remove('hidden'); // Show play again button
                    }

                    renderBoard(); // Re-render the board with the new state
                    updateGameInfo(); // Update current player display
                }
            });
        }

        // --- GAME LOGIC (no changes from previous complete code) ---

        // Function to render the board based on the 'board' array
        function renderBoard() {
            boardElement.innerHTML = ''; // Clear existing board
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const square = document.createElement('div');
                    square.classList.add('square');
                    square.dataset.row = row;
                    square.dataset.col = col;

                    const pieceType = board[row][col];
                    if (pieceType !== 0) {
                        const piece = document.createElement('div');
                        piece.classList.add('piece');
                        piece.dataset.row = row;
                        piece.dataset.col = col;

                        // Use player-color classes
                        if (pieceType === 1 || pieceType === '1K') {
                            piece.classList.add('player-1-color');
                            piece.textContent = (pieceType === 1) ? 'S' : 'K';
                        } else if (pieceType === 2 || pieceType === '2K') {
                            piece.classList.add('player-2-color');
                            piece.textContent = (pieceType === 2) ? 'S' : 'K';
                        }
                        if (pieceType === '1K' || pieceType === '2K') {
                            piece.classList.add('king');
                        }
                        
                        piece.addEventListener('click', handlePieceClick);
                        square.appendChild(piece);
                    }
                    square.addEventListener('click', handleSquareClick); // Add click listener to squares for movement
                    boardElement.appendChild(square);
                }
            }
            updateGameInfo();
        }

        // Helper function to check if coordinates are within board bounds
        function isInBounds(row, col) {
            return row >= 0 && row < 5 && col >= 0 && col < 5;
        }

        // Helper function to check if a square is occupied
        function isOccupied(row, col) {
            return board[row][col] !== 0;
        }

        // Function to determine if a move is valid according to King's Valley rules
        function isValidMove(startRow, startCol, targetRow, targetCol) {
            // 1. Target must be empty and within bounds
            if (!isInBounds(targetRow, targetCol) || isOccupied(targetRow, targetCol)) {
                return false;
            }

            const pieceType = board[startRow][startCol];
            const isKing = (pieceType === '1K' || pieceType === '2K');

            // 2. Calculate direction
            const dRow = targetRow - startRow;
            const dCol = targetCol - startCol;

            let rowDir = 0;
            let colDir = 0;

            if (dRow === 0 && dCol !== 0) { // Horizontal
                colDir = dCol > 0 ? 1 : -1;
            } else if (dCol === 0 && dRow !== 0) { // Vertical
                rowDir = dRow > 0 ? 1 : -1;
            } else if (Math.abs(dRow) === Math.abs(dCol) && dRow !== 0) { // Diagonal
                rowDir = dRow > 0 ? 1 : -1;
                colDir = dCol > 0 ? 1 : -1;
            } else {
                return false; // Not horizontal, vertical, or diagonal
            }

            // 3. Simulate the slide to find the *actual* stopping point
            let currentRow = startRow + rowDir;
            let currentCol = startCol + colDir;
            let actualStopRow = startRow;
            let actualStopCol = startCol;

            while (isInBounds(currentRow, currentCol) && !isOccupied(currentRow, currentCol)) {
                actualStopRow = currentRow;
                actualStopCol = currentCol;
                currentRow += rowDir;
                currentCol += colDir;
            }

            // The piece must stop at the actualStopRow/Col
            // So, the targetRow/Col must be equal to actualStopRow/Col
            if (targetRow !== actualStopRow || targetCol !== actualStopCol) {
                return false; // Piece stopped mid-slide or went past an obstacle/edge
            }

            // Special rule: Soldier cannot stop on the King's Valley (2,2)
            if (targetRow === 2 && targetCol === 2 && !isKing) {
                return false; // Soldier cannot stop on King's Valley
            }

            return true; // Valid move
        }

        // Function to find and highlight all valid moves for the selected piece
        function highlightValidMoves() {
            // Clear existing highlights
            document.querySelectorAll('.highlight-move').forEach(square => {
                square.classList.remove('highlight-move');
            });

            if (!selectedPieceCoords) return;

            const [startRow, startCol] = selectedPieceCoords;

            // Check all possible target squares
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    if (isValidMove(startRow, startCol, row, col)) {
                        const targetSquare = boardElement.querySelector(`.square[data-row="${row}"][data-col="${col}"]`);
                        if (targetSquare) {
                            targetSquare.classList.add('highlight-move');
                        }
                    }
                }
            }
        }

        // Handles clicking on a piece (to select it)
        function handlePieceClick(event) {
            const clickedPiece = event.target;
            const row = parseInt(clickedPiece.dataset.row);
            const col = parseInt(clickedPiece.dataset.col);
            const pieceType = board[row][col];

            // Only allow current player to select their pieces and it must be their turn
            if ( (isPlayer1 && currentPlayer === 1 && (pieceType === 1 || pieceType === '1K')) ||
                 (!isPlayer1 && currentPlayer === 2 && (pieceType === 2 || pieceType === '2K')) ) {

                if (selectedPiece) {
                    selectedPiece.classList.remove('border-4', 'border-yellow-400');
                }
                selectedPiece = clickedPiece;
                selectedPieceCoords = [row, col];
                selectedPiece.classList.add('border-4', 'border-yellow-400');
                gameMessage.textContent = `Piece selected at (${row}, ${col}). Now click a highlighted square to move.`;
                highlightValidMoves();
            } else if ( (isPlayer1 && currentPlayer !== 1) || (!isPlayer1 && currentPlayer !== 2) ){
                gameMessage.textContent = "It's not your turn!";
            }
            else {
                gameMessage.textContent = "That's not your piece!";
                if (selectedPiece) {
                    selectedPiece.classList.remove('border-4', 'border-yellow-400');
                    selectedPiece = null;
                    selectedPieceCoords = null;
                }
                document.querySelectorAll('.highlight-move').forEach(square => {
                    square.classList.remove('highlight-move');
                });
            }
        }

        // Handles clicking on a square (to move to it)
        async function handleSquareClick(event) { // Make this function async
            const clickedSquare = event.currentTarget;
            const targetRow = parseInt(clickedSquare.dataset.row);
            const targetCol = parseInt(clickedSquare.dataset.col);

            if (selectedPiece && selectedPieceCoords) {
                const [startRow, startCol] = selectedPieceCoords;

                // Ensure it's the current player's turn based on client's identity
                const playerTurn = isPlayer1 ? 1 : 2;
                if (currentPlayer !== playerTurn) {
                    gameMessage.textContent = "It's not your turn!";
                    return;
                }

                if (isValidMove(startRow, startCol, targetRow, targetCol)) {
                    // Perform the move on a *temporary* local board first
                    let newBoard = JSON.parse(JSON.stringify(board)); // Deep copy
                    newBoard[targetRow][targetCol] = newBoard[startRow][startCol];
                    newBoard[startRow][startCol] = 0;

                    const pieceMoved = newBoard[targetRow][targetCol];
                    let nextPlayer = currentPlayer === 1 ? 2 : 1;
                    let newStatus = 'playing';
                    let winner = null;

                    if ((pieceMoved === '1K' || pieceMoved === '2K') && targetRow === 2 && targetCol === 2) {
                        gameMessage.textContent = `Player ${currentPlayer} wins! The King reached the King's Valley!`;
                        newStatus = 'finished';
                        winner = currentPlayer;
                        // No turn switch if game is over
                    }

                    // Update the Realtime Database with the new game state
                    const gameRef = ref(database, 'games/' + currentGameId);
                    await set(gameRef, {
                        board: newBoard,
                        currentPlayer: newStatus === 'finished' ? currentPlayer : nextPlayer, // Keep current player if game finished
                        player1Name: player1Name, // Pass along names
                        player2Name: player2Name,
                        status: newStatus,
                        winner: winner // Add winner field if game finished
                    });
                    // The `onValue` listener will automatically update the local `board` and `currentPlayer`
                    // and re-render the board for *both* players.

                    // Deselect piece and clear highlights locally immediately for smoother UX
                    selectedPiece.classList.remove('border-4', 'border-yellow-400');
                    selectedPiece = null;
                    selectedPieceCoords = null;
                    document.querySelectorAll('.highlight-move').forEach(square => {
                        square.classList.remove('highlight-move');
                    });

                    // Don't switch current player locally, let the database update drive it
                    // The gameMessage will be updated by the onValue listener
                } else {
                    gameMessage.textContent = "Invalid move. Please select a highlighted square.";
                }
            } else {
                gameMessage.textContent = "Select a piece first!";
            }
        }

        // Updates the display for current player and messages
        function updateGameInfo() {
            // NEW: Use player nicknames for display
            let currentDisplay = ``;
            if (currentPlayer === 1) {
                currentDisplay = `${player1Name} (Red)`;
            } else {
                currentDisplay = `${player2Name} (Blue)`;
            }
            currentPlayerDisplay.textContent = currentDisplay;
            currentPlayerDisplay.classList.remove('text-red-500', 'text-blue-500');
            if (currentPlayer === 1) {
                currentPlayerDisplay.classList.add('text-red-500');
            } else {
                currentPlayerDisplay.classList.add('text-blue-500');
            }
        }
    </script>
</body>
</html>
